<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">4.3 Spend Bundles | Chia Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://cpp6d.github.io/chia-docs//docs/04coin-set-model/spend_bundles"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="4.3 Spend Bundles | Chia Documentation"><meta data-react-helmet="true" name="description" content="A spend bundle is a set of spends of multiple coins, which is usually submitted to full nodes for inclusion into the blockchain. In Bitcoin, the equivalent data structure would be the transaction."><meta data-react-helmet="true" property="og:description" content="A spend bundle is a set of spends of multiple coins, which is usually submitted to full nodes for inclusion into the blockchain. In Bitcoin, the equivalent data structure would be the transaction."><link data-react-helmet="true" rel="shortcut icon" href="/img/chia_leaf_green.svg"><link data-react-helmet="true" rel="canonical" href="https://cpp6d.github.io/chia-docs//docs/04coin-set-model/spend_bundles"><link data-react-helmet="true" rel="alternate" href="https://cpp6d.github.io/chia-docs//docs/04coin-set-model/spend_bundles" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cpp6d.github.io/chia-docs//docs/04coin-set-model/spend_bundles" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.864117c7.css">
<link rel="preload" href="/assets/js/runtime~main.73889518.js" as="script">
<link rel="preload" href="/assets/js/main.7dba6002.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/chia-docs-icon.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/chia-docs-icon.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title"> Chia Docs</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/01introduction/what-is-chia">Docs</a><a href="https://www.chia.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia.net</a><a href="https://github.com/Chia-Network/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia Github</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_CDc6"><kbd class="searchHint_2RRg">ctrl</kbd><kbd class="searchHint_2RRg">K</kbd></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">1 - Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">2 - Architecture</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">3 - Consensus Algorithm</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">4 - Coin Set Model</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/04coin-set-model/what-is-a-coin">4.1 Coins, Puzzles and Solutions</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/04coin-set-model/conditions">4.2 Conditions</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/04coin-set-model/spend_bundles">4.3 Spend Bundles</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/04coin-set-model/addresses">4.4 Addresses</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">5 - Block Validation</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">6 - Mempool</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">7 - Networking</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">8 - Serialization</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">9 - Keys and Signatures</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">10 - Protocol</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">11 - Pool Protocol</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">12 - RPC APIs</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">13 - Command Line Interface</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">14 - Python Implementation</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">15 - Resources</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>4.3 Spend Bundles</h1></header><p>A spend bundle is a set of spends of multiple coins, which is usually submitted to full nodes for inclusion into the blockchain. In Bitcoin, the equivalent data structure would be the transaction.</p><p>Here is the spend bundle&#x27;s basic construction:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(17, 17, 17)">CoinSpend</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#403f53"><span class="token plain">    coin</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> Coin</span></span><span class="token-line" style="color:#403f53"><span class="token plain">    puzzle_reveal</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> SerializedProgram</span></span><span class="token-line" style="color:#403f53"><span class="token plain">    solution</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> SerializedProgram</span></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(17, 17, 17)">SpendBundle</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#403f53"><span class="token plain">    coin_spends</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token plain">CoinSpend</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#403f53"><span class="token plain">    aggregated_signature</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> G2Element</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see in the code sample above, a spend bundle is a group of coin spends, where each coin spend includes the coin being spent, the puzzle program, and the solution program. Each solution is passed into each puzzle and run through the CLVM, where it outputs conditions. Two of the conditions -- <code>AGG_SIG_ME</code> and <code>AGG_SIG_UNSAFE</code> -- require
that a signature be present in order for the spend to be valid.</p><p>Usually when making a transaction, a user would combine multiple spends, to achieve the desired value of the transaction. Users can also combine coins that represent <a href="https://chialisp.com/docs/puzzles/cats" target="_blank" rel="noopener noreferrer">CATs</a> (Chia Asset Tokens), and send different types of values in the same spend bundle.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="aggregate-signatures"></a>Aggregate Signatures<a class="hash-link" href="#aggregate-signatures" title="Direct link to heading">#</a></h2><p>In Bitcoin, each spend has its own signature or signatures, one for each <code>(public key, message)</code> combination. Then, each signature <code>s_i</code> is passed through a signature verification algorithm: <code>V(s, m, pk) -&gt; T/F</code>, with the message <code>m</code> and public key <code>pk</code>, and would be valid if and only if <code>V</code> returns true.</p><p>In Chia, BLS signatures are used. These signatures can be combined (added) together to produce an aggregate signature of the same size as the originals. Let&#x27;s say we have three spend bundles, each with its own pair:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#403f53"><span class="token plain">s1 m1 pk1</span></span><span class="token-line" style="color:#403f53"><span class="token plain">s2 m2 pk2</span></span><span class="token-line" style="color:#403f53"><span class="token plain">s3 m3 pk3</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>With BLS signatures, farmers combine all three signatures <code>s1, s2, and s3</code> into one signature <code>s_agg</code>. The BLS signature verification can take multiple public keys and messages: <code>V(s, [m1, m2, ... mx], [pk1, pk2, ... pkx]) -&gt; T/F</code>.</p><p>This allows the farmer to combine all three spend bundles into one spend bundle, with only one signature, which means less data is transmitted and stored on chain and disk.</p><p>Another benefit of these aggregate signatures is that when spending multiple coins, users will only transmit one signature, instead of one or more per spend. More information can be found in <a title="Section 9.1: Keys and Signatures" href="/docs/09keys/keys-and-signatures">Section 9.1</a>. You can also read the <a href="https://github.com/Chia-Network/bls-signatures" target="_blank" rel="noopener noreferrer">code for BLS signatures</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="coins-vs-spend-bundles"></a>Coins vs Spend Bundles<a class="hash-link" href="#coins-vs-spend-bundles" title="Direct link to heading">#</a></h2><p>One major difference between Chia and other UTXO-based blockchain systems is that spend bundles are not a first-class object in the block database. Each block in chia contains a list of removals and additions, where removals are the coins spent in that block, and additions are the coins added in that block.</p><p>Let&#x27;s say a farmer wants to include 1000 spend bundles into a block. First, they can combine all spend bundles into one, and then they can make the block. Each block will have exactly one signature for all spends. Full nodes that verify and store this block do not need to know the original information of which spends were bundled with which other spends.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="additions-and-removals"></a>Additions and Removals<a class="hash-link" href="#additions-and-removals" title="Direct link to heading">#</a></h2><p>In the figure below, you can see a spend bundle that was created by a user. The removals in the spend bundle are coins A, B, and C, and the additions are coins D and E. This is very similar to how the standard transaction script works in <code>chia-blockchain</code>.</p><figure><img src="/img/spend_bundle.png" alt="drawing"></figure><p>Let&#x27;s go through the different components in the image. First, let&#x27;s say Alice wants to send 13 XCH to Bob. Alice looks at her coin database, and selects 3 unspent coins (A, B, and C) that add up to at least 13 XCH. Each one of these coins has an associated CLVM puzzle, which has a public key encoded inside of it. Let&#x27;s denote these public keys as <code>pkA</code>, <code>pkB</code>, and <code>pkC</code>.  Alice needs to generate the puzzle and solution for each of the
spends, in order to create the spend bundle.</p><p>Each puzzle, when run with the solutions, returns an <code>AGG_SIG</code> condition (either AGG_SIG_ME or AGG_SIG_UNSAFE). This means that a signature is required from the respective public key, in order for this spend to be valid.</p><p>Instead of providing 3 signatures, we can use BLS signature arithmetic to combine all three into one signature. There are two benefits to doing this:</p><ol><li>The resulting spend bundle will be smaller in bytes.</li><li>The spend bundle can not be unbundled (the signature cannot be de-aggregated).</li></ol><p>That is, an attacker who obtains Alice&#x27;s spend bundle is not able to pull apart the spend bundle in order to spend just one of the coins. When Alice sends this spend bundle to the Chia network, other full nodes will run the CLVM programs, collect all the <code>AGG_SIG</code> conditions, and then verify them using the aggregate signature provided in the spend bundle.</p><p>The first puzzle here for coin A also returns two <code>CREATE_COIN</code> conditions. This means that two coins must be added to the coin database in order for spend A to be valid:</p><ol><li>Coin D is for Bob (puzzle hash 0x1b54f and 13 XCH).</li><li>Coin E is Alice&#x27;s change. She spent 14 XCH, but only wanted to send 13 XCH to Bob. Each coin&#x27;s value must be spent entirely, so Alice needs to send 1 XCH to herself as change.</li></ol><p>Note that the puzzle hash of coin E is the same as that of coin A. Puzzle hashes can be reused. When spending coin E, Alice would sign with the same key as before, but would most likely use a different message that spends to another recipient.</p><p>Also note that only the first spend is creating the coins. This is the normal way to combine spends, since each coin must have exactly one parent. Spend A, by itself, would not be valid, since it creates more value (14 XCH) than it spends (5 XCH). However, the spend becomes valid when combined with spends B and C.</p><p>Full nodes receive, validate, and store the spend bundle in memory. However, when creating a new block, farming nodes will combine many spend bundles from different users. This creates one large spend bundle with one signature. When looking at just the block, it is not always clear which spends were bundled together initially. However, we can see the net additions and removals in the whole block.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="what-do-full-nodes-store-on-chain"></a>What do full nodes store on-chain?<a class="hash-link" href="#what-do-full-nodes-store-on-chain" title="Direct link to heading">#</a></h2><p>Puzzles are only revealed when coins are spent; the puzzles are saved on-chain afterward for record-keeping purposes.</p><p>Full nodes, therefore, store the history of the blockchain, which includes all revealed puzzles and solutions, for all spent coins. Full nodes also store a list of unspent coins, which only contains puzzle hashes, and not puzzles.</p><p>Users are responsible for remembering and storing their own puzzles in order to spend their coins. Usually these are regenerated on the fly by wallet software, based on templates.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Chia-Network/chia-docs/blob/main/docs/04coin-set-model/spend_bundles.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/04coin-set-model/conditions"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« 4.2 Conditions</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/04coin-set-model/addresses"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">4.4 Addresses Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#aggregate-signatures" class="table-of-contents__link">Aggregate Signatures</a></li><li><a href="#coins-vs-spend-bundles" class="table-of-contents__link">Coins vs Spend Bundles</a></li><li><a href="#additions-and-removals" class="table-of-contents__link">Additions and Removals</a></li><li><a href="#what-do-full-nodes-store-on-chain" class="table-of-contents__link">What do full nodes store on-chain?</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Approach</div><ul class="footer__items"><li class="footer__item"><a href="https://www.chia.net/approach" target="_blank" rel="noopener noreferrer" class="footer__link-item">White Paper</a></li></ul></div><div class="col footer__col"><div class="footer__title">Technology</div><ul class="footer__items"><li class="footer__item"><a href="https://www.chia.net/greenpaper" target="_blank" rel="noopener noreferrer" class="footer__link-item">Green Paper</a></li><li class="footer__item"><a href="https://www.chia.net/assets/Chia-New-Consensus-0.9.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Consensus 1.1</a></li></ul></div><div class="col footer__col"><div class="footer__title">Developers</div><ul class="footer__items"><li class="footer__item"><a href="https://www.chia.net/grants" target="_blank" rel="noopener noreferrer" class="footer__link-item">Grants</a></li><li class="footer__item"><a href="https://www.chialisp.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chialisp</a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items"><li class="footer__item"><a href="https://chia.net/about" target="_blank" rel="noopener noreferrer" class="footer__link-item">About</a></li><li class="footer__item"><a href="https://chia.net/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li><li class="footer__item"><a href="https://chia.net/contact" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Â© 2022 Chia Network Inc., Licensed under the <a href="https://github.com/Chia-Network/chia-docs/blob/main/LICENSE" target="_blank">Apache License, Version 2.0</a> | <a href="https://www.chia.net/terms">Terms</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.73889518.js"></script>
<script src="/assets/js/main.7dba6002.js"></script>
</body>
</html>